name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      release_type:
        description: 'Type of release'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel twine
      
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            # Determine release type from version
            if [[ "$VERSION" =~ ^[0-9]+\.0\.0$ ]]; then
              RELEASE_TYPE="major"
            elif [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.0$ ]]; then
              RELEASE_TYPE="minor"
            else
              RELEASE_TYPE="patch"
            fi
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
      
      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ steps.version.outputs.tag }}^ 2>/dev/null || echo "")
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"
      
      - name: Generate comprehensive release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_TYPE="${{ steps.version.outputs.release_type }}"
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"
          CURRENT_TAG="${{ steps.version.outputs.tag }}"
          
          # Get commits since last tag
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
            COMMIT_COUNT=$(git rev-list ${PREV_TAG}..HEAD --count --no-merges)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges | head -20)
            COMMIT_COUNT=$(git rev-list HEAD --count --no-merges)
          fi
          
          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -iE "feat:|feature:|âœ¨|add " || echo "")
          FIXES=$(echo "$COMMITS" | grep -iE "fix:|bugfix:|ðŸ›|resolve " || echo "")
          DOCS=$(echo "$COMMITS" | grep -iE "docs:|documentation:|ðŸ“š|update.*doc" || echo "")
          PERF=$(echo "$COMMITS" | grep -iE "perf:|performance:|âš¡|optimize" || echo "")
          REFACTOR=$(echo "$COMMITS" | grep -iE "refactor:|â™»ï¸|restructure" || echo "")
          TESTS=$(echo "$COMMITS" | grep -iE "test:|ðŸ§ª|add.*test" || echo "")
          CHORES=$(echo "$COMMITS" | grep -iE "chore:|ðŸ”§|update.*deps" || echo "")
          
          # Create comprehensive release notes
          cat > release_notes.md << EOF
          ## ðŸŽ‰ SLM Builder v$VERSION
          
          $(if [ "$RELEASE_TYPE" == "major" ]; then
            echo "### ðŸš¨ Major Release"
            echo "This is a major release with significant new features and potential breaking changes."
          elif [ "$RELEASE_TYPE" == "minor" ]; then
            echo "### âœ¨ Minor Release"
            echo "This release adds new features and improvements while maintaining backward compatibility."
          else
            echo "### ðŸ› Patch Release"
            echo "This release includes bug fixes and minor improvements."
          fi)
          
          ### ðŸ“Š Release Statistics
          - **Commits**: $COMMIT_COUNT$([ -n "$PREV_TAG" ] && echo " since $PREV_TAG" || echo " total")
          - **Release Type**: ${RELEASE_TYPE}
          - **Date**: $(date +"%B %d, %Y")
          
          EOF
          
          # Add categorized changes
          if [ ! -z "$FEATURES" ]; then
            cat >> release_notes.md << EOF
          ### âœ¨ New Features
          $FEATURES
          
          EOF
          fi
          
          if [ ! -z "$FIXES" ]; then
            cat >> release_notes.md << EOF
          ### ðŸ› Bug Fixes
          $FIXES
          
          EOF
          fi
          
          if [ ! -z "$PERF" ]; then
            cat >> release_notes.md << EOF
          ### âš¡ Performance Improvements
          $PERF
          
          EOF
          fi
          
          if [ ! -z "$DOCS" ]; then
            cat >> release_notes.md << EOF
          ### ðŸ“š Documentation
          $DOCS
          
          EOF
          fi
          
          if [ ! -z "$REFACTOR" ]; then
            cat >> release_notes.md << EOF
          ### â™»ï¸ Code Refactoring
          $REFACTOR
          
          EOF
          fi
          
          if [ ! -z "$TESTS" ]; then
            cat >> release_notes.md << EOF
          ### ðŸ§ª Tests
          $TESTS
          
          EOF
          fi
          
          if [ ! -z "$CHORES" ]; then
            cat >> release_notes.md << EOF
          ### ðŸ”§ Maintenance
          $CHORES
          
          EOF
          fi
          
          # Add installation and documentation
          cat >> release_notes.md << EOF
          ---
          
          ## ðŸ“¦ Installation
          
          \`\`\`bash
          pip install slm-builder==$VERSION
          \`\`\`
          
          Or upgrade from a previous version:
          
          \`\`\`bash
          pip install --upgrade slm-builder
          \`\`\`
          
          ## ðŸŽ¯ Key Features
          
          - ðŸ“¥ **14 Data Sources**: CSV, JSONL, SQL, MongoDB, REST APIs, and more
          - ðŸŽ¯ **Multiple Tasks**: QA, classification, generation, instruction-tuning
          - ðŸš€ **Easy Training**: Pre-configured recipes (LoRA, full fine-tuning)
          - ðŸ’» **CPU & GPU**: Optimized for both environments
          - ðŸ“Š **Model Comparison**: Benchmark multiple models
          - ðŸ”¬ **Advanced Metrics**: Perplexity, BLEU, ROUGE, Accuracy, F1
          - âš¡ **Quantization**: 4-bit and 8-bit model compression
          - ðŸ“¦ **Multiple Exports**: ONNX, TorchScript, HuggingFace
          
          ## ðŸ“š Documentation
          
          - ðŸ“– [Documentation Site](https://isathish.github.io/slm/)
          - ðŸš€ [Quick Start Guide](https://github.com/${{ github.repository }}/blob/main/docs/QUICK_REFERENCE.md)
          - ðŸ“ [Installation Guide](https://github.com/${{ github.repository }}/blob/main/docs/INSTALLATION.md)
          - âœ¨ [Features](https://github.com/${{ github.repository }}/blob/main/docs/FEATURES.md)
          - ðŸ’¡ [Examples](https://github.com/${{ github.repository }}/tree/main/examples)
          - ðŸ¤ [Contributing](https://github.com/${{ github.repository }}/blob/main/docs/CONTRIBUTING.md)
          
          ## ðŸ”— Quick Links
          
          - [GitHub Repository](https://github.com/${{ github.repository }})
          - [Issue Tracker](https://github.com/${{ github.repository }}/issues)
          - [Discussions](https://github.com/${{ github.repository }}/discussions)
          
          $(if [ -n "$PREV_TAG" ]; then
            echo "## ðŸ“ Full Changelog"
            echo ""
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${CURRENT_TAG}"
          else
            echo "## ðŸ“ Changelog"
            echo ""
            echo "This is the first release. See [commit history](https://github.com/${{ github.repository }}/commits/${CURRENT_TAG}) for details."
          fi)
          EOF
          
          echo "âœ… Comprehensive release notes generated"
          cat release_notes.md
      
      - name: Update CHANGELOG.md
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_DATE=$(date +"%Y-%m-%d")
          
          # Create changelog entry from release notes
          {
            echo "# Changelog"
            echo ""
            echo "## [v$VERSION] - $RELEASE_DATE"
            echo ""
            cat release_notes.md | grep -A 1000 "^###" | grep -B 1000 "^---" | head -n -1
            echo ""
            if [ -f docs/CHANGELOG.md ]; then
              tail -n +2 docs/CHANGELOG.md
            fi
          } > docs/CHANGELOG.md.new
          
          mv docs/CHANGELOG.md.new docs/CHANGELOG.md
          
          # Commit changelog update
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/CHANGELOG.md
          git commit -m "ðŸ“ Update CHANGELOG for v$VERSION" || echo "No changes to commit"
          git push origin main || echo "Nothing to push"
      
      - name: Create Git tag (if workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.tag }}"
      
      - name: Check if release exists
        id: check_release
        run: |
          if gh release view ${{ steps.version.outputs.tag }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release ${{ steps.version.outputs.tag }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release ${{ steps.version.outputs.tag }} does not exist"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Create GitHub Release
        if: steps.check_release.outputs.exists != 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build package
        run: |
          # Create setup.py if it doesn't exist
          if [ ! -f setup.py ]; then
            cat > setup.py << 'EOF'
          from setuptools import setup, find_packages
          
          with open("README.md", "r", encoding="utf-8") as fh:
              long_description = fh.read()
          
          setup(
              name="slm-builder",
              version="${{ steps.version.outputs.version }}",
              author="SLM Builder Team",
              description="Build Small/Specialized Language Models from any dataset, source, or topic",
              long_description=long_description,
              long_description_content_type="text/markdown",
              url="https://github.com/${{ github.repository }}",
              packages=find_packages(),
              classifiers=[
                  "Development Status :: 4 - Beta",
                  "Intended Audience :: Developers",
                  "Intended Audience :: Science/Research",
                  "License :: OSI Approved :: MIT License",
                  "Programming Language :: Python :: 3",
                  "Programming Language :: Python :: 3.8",
                  "Programming Language :: Python :: 3.9",
                  "Programming Language :: Python :: 3.10",
                  "Programming Language :: Python :: 3.11",
                  "Topic :: Scientific/Engineering :: Artificial Intelligence",
              ],
              python_requires=">=3.8",
              install_requires=[
                  "torch>=2.0.0",
                  "transformers>=4.30.0",
                  "datasets>=2.12.0",
                  "peft>=0.4.0",
                  "accelerate>=0.20.0",
                  "bitsandbytes>=0.40.0",
              ],
              extras_require={
                  "full": [
                      "sqlalchemy>=2.0.0",
                      "psycopg2-binary>=2.9.0",
                      "pymongo>=4.0.0",
                      "pymysql>=1.0.0",
                      "requests>=2.28.0",
                      "tqdm>=4.65.0",
                      "nltk>=3.8.0",
                      "rouge-score>=0.1.0",
                  ],
                  "dev": [
                      "black>=23.0.0",
                      "isort>=5.12.0",
                      "flake8>=6.0.0",
                      "pytest>=7.3.0",
                  ],
              },
              entry_points={
                  "console_scripts": [
                      "slm=slm_builder.cli:main",
                  ],
              },
          )
          EOF
          fi
          
          python setup.py sdist bdist_wheel
      
      - name: Upload Release Assets
        if: steps.check_release.outputs.exists != 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          files: |
            dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment on commit
        run: |
          COMMIT_SHA="${{ github.sha }}"
          gh api repos/${{ github.repository }}/commits/$COMMIT_SHA/comments \
            -f body="ðŸŽ‰ Release ${{ steps.version.outputs.version }} has been published! [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
