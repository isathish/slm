name: Auto Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.github/**'
      - 'examples/**'

permissions:
  contents: write

jobs:
  auto-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Get current version
        id: current_version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            VERSION="1.0.0"
            echo "1.0.0" > VERSION
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"
      
      - name: Determine version bump type from commits
        id: bump_type
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            echo "No previous tag found, checking all commits"
            COMMITS=$(git log --pretty=format:"%s" --no-merges)
          else
            echo "Last tag: $LAST_TAG"
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s" --no-merges)
          fi
          
          echo "Analyzing commits:"
          echo "$COMMITS"
          echo ""
          
          # Check for breaking changes (MAJOR)
          if echo "$COMMITS" | grep -qiE "BREAKING CHANGE|breaking:|major:"; then
            BUMP_TYPE="major"
            echo "ðŸš¨ MAJOR bump detected (breaking changes)"
          # Check for features (MINOR)
          elif echo "$COMMITS" | grep -qiE "feat:|feature:|âœ¨|minor:"; then
            BUMP_TYPE="minor"
            echo "âœ¨ MINOR bump detected (new features)"
          # Check for fixes/patches (PATCH)
          elif echo "$COMMITS" | grep -qiE "fix:|bugfix:|ðŸ›|patch:"; then
            BUMP_TYPE="patch"
            echo "ðŸ› PATCH bump detected (bug fixes)"
          # Check for other changes
          elif echo "$COMMITS" | grep -qiE "chore:|docs:|refactor:|test:|perf:"; then
            BUMP_TYPE="patch"
            echo "ðŸ”§ PATCH bump detected (maintenance)"
          else
            BUMP_TYPE="none"
            echo "â„¹ï¸  No version bump needed"
          fi
          
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
      
      - name: Calculate new version
        id: new_version
        if: steps.bump_type.outputs.bump_type != 'none'
        run: |
          CURRENT="${{ steps.current_version.outputs.version }}"
          BUMP_TYPE="${{ steps.bump_type.outputs.bump_type }}"
          
          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH="${VERSION_PARTS[2]}"
          
          case $BUMP_TYPE in
            major)
              NEW_VERSION="$((MAJOR+1)).0.0"
              ;;
            minor)
              NEW_VERSION="${MAJOR}.$((MINOR+1)).0"
              ;;
            patch)
              NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH+1))"
              ;;
            *)
              echo "Error: Invalid bump type"
              exit 1
              ;;
          esac
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ New version: $NEW_VERSION (was $CURRENT)"
      
      - name: Check if tag exists
        id: check_tag
        if: steps.bump_type.outputs.bump_type != 'none'
        run: |
          TAG="v${{ steps.new_version.outputs.new_version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Tag $TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag $TAG does not exist, will create"
          fi
      
      - name: Update VERSION file
        if: steps.bump_type.outputs.bump_type != 'none' && steps.check_tag.outputs.exists != 'true'
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          echo "$NEW_VERSION" > VERSION
          echo "âœ… Updated VERSION to $NEW_VERSION"
      
      - name: Commit version bump
        if: steps.bump_type.outputs.bump_type != 'none' && steps.check_tag.outputs.exists != 'true'
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          BUMP_TYPE="${{ steps.bump_type.outputs.bump_type }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add VERSION
          git commit -m "ðŸ”– Bump version to v${NEW_VERSION} [${BUMP_TYPE}]"
          
          echo "âœ… Committed version bump"
      
      - name: Create and push tag
        if: steps.bump_type.outputs.bump_type != 'none' && steps.check_tag.outputs.exists != 'true'
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          BUMP_TYPE="${{ steps.bump_type.outputs.bump_type }}"
          
          git tag -a "v${NEW_VERSION}" -m "Release v${NEW_VERSION} [${BUMP_TYPE}]"
          
          # Push commit and tag
          git push origin main
          git push origin "v${NEW_VERSION}"
          
          echo "âœ… Created and pushed tag v${NEW_VERSION}"
      
      - name: Summary
        if: steps.bump_type.outputs.bump_type != 'none'
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ‰ Auto Release Summary
          
          - **Bump Type**: ${{ steps.bump_type.outputs.bump_type }}
          - **Previous Version**: ${{ steps.current_version.outputs.version }}
          - **New Version**: ${{ steps.new_version.outputs.new_version }}
          - **Tag**: v${{ steps.new_version.outputs.new_version }}
          
          ### ðŸ“‹ Next Steps
          The tag has been created and pushed. The release workflow will now:
          1. Generate comprehensive release notes
          2. Build packages
          3. Create GitHub release
          4. Update CHANGELOG.md
          
          **Release will be available at**: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.new_version.outputs.new_version }}
          EOF
      
      - name: No release needed
        if: steps.bump_type.outputs.bump_type == 'none'
        run: |
          echo "â„¹ï¸  No version bump needed - no releasable changes detected"
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## â„¹ï¸  No Release Needed
          
          No releasable changes detected in recent commits.
          
          To trigger a release, use commit messages with:
          - \`feat:\` or \`âœ¨\` for minor releases
          - \`fix:\` or \`ðŸ›\` for patch releases  
          - \`BREAKING CHANGE:\` or \`major:\` for major releases
          EOF
